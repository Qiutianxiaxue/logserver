# ClickHouse æ—¥å¿—å­˜å‚¨æ‰©å±•æŒ‡å—

## å½“å‰è¡¨è®¾è®¡è¯„ä¼°

### âœ… å•è¡¨è®¾è®¡çš„ä¼˜åŠ¿

å½“å‰çš„ `application_logs` è¡¨è®¾è®¡å·²ç»åŒ…å«äº†ClickHouseçš„æœ€ä½³å®žè·µï¼š

```sql
CREATE TABLE application_logs (
  id UUID DEFAULT generateUUIDv4(),
  timestamp DateTime64(3) DEFAULT now64(),
  level String,
  message String,
  service String DEFAULT '',
  -- ... å…¶ä»–å­—æ®µ ...
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(timestamp)      -- æŒ‰æœˆåˆ†åŒº
ORDER BY (timestamp, level, service)  -- ä¼˜åŒ–æŽ’åºé”®
TTL timestamp + INTERVAL 90 DAY       -- è‡ªåŠ¨æ¸…ç†
SETTINGS index_granularity = 8192
```

**ä¼˜åŠ¿ï¼š**
- ðŸ“… **è‡ªåŠ¨åˆ†åŒº**: æŒ‰æœˆåˆ†åŒºï¼ŒæŸ¥è¯¢æ—¶åªæ‰«æç›¸å…³æ—¶é—´æ®µ
- ðŸš€ **æŸ¥è¯¢ä¼˜åŒ–**: æŽ’åºé”®é’ˆå¯¹å¸¸è§æŸ¥è¯¢æ¨¡å¼ä¼˜åŒ–
- ðŸ—‘ï¸ **è‡ªåŠ¨æ¸…ç†**: TTLè‡ªåŠ¨åˆ é™¤è¿‡æœŸæ•°æ®
- ðŸ’¾ **é«˜åŽ‹ç¼©**: åˆ—å¼å­˜å‚¨ + åŽ‹ç¼©ç®—æ³•ï¼Œå­˜å‚¨æ•ˆçŽ‡æžé«˜

### ðŸ“ˆ æ€§èƒ½é¢„ä¼°

| æ—¥å¿—é‡/å¤© | æœˆæ•°æ®é‡ | å¹´æ•°æ®é‡ | æŸ¥è¯¢æ€§èƒ½ | æŽ¨èæ–¹æ¡ˆ |
|---------|---------|---------|---------|---------|
| 1ä¸‡æ¡   | 30ä¸‡æ¡   | 360ä¸‡æ¡  | æ¯«ç§’çº§   | å•è¡¨ |
| 10ä¸‡æ¡  | 300ä¸‡æ¡  | 3600ä¸‡æ¡ | æ¯«ç§’çº§   | å•è¡¨ |
| 100ä¸‡æ¡ | 3000ä¸‡æ¡ | 3.6äº¿æ¡  | ç§’çº§     | å•è¡¨ |
| 1000ä¸‡æ¡| 3äº¿æ¡    | 36äº¿æ¡   | ç§’çº§     | å•è¡¨æˆ–è€ƒè™‘åˆ†è¡¨ |

## ðŸ”„ ä½•æ—¶è€ƒè™‘åˆ†è¡¨

### åœºæ™¯1: è¶…å¤§æ•°æ®é‡
```
æ—¥å¿—é‡ > 1000ä¸‡æ¡/å¤© ä¸” æŸ¥è¯¢æ€§èƒ½ä¸æ»¡è¶³éœ€æ±‚
```

### åœºæ™¯2: å¤šç§Ÿæˆ·éš”ç¦»
```
ä¸åŒå®¢æˆ·/é¡¹ç›®éœ€è¦ä¸¥æ ¼çš„æ•°æ®éš”ç¦»
```

### åœºæ™¯3: ä¸åŒæ•°æ®ç”Ÿå‘½å‘¨æœŸ
```
ä¸åŒç±»åž‹æ—¥å¿—æœ‰ä¸åŒçš„ä¿ç•™ç­–ç•¥
```

## ðŸ—ï¸ åˆ†è¡¨ç­–ç•¥

### ç­–ç•¥1: æŒ‰æœåŠ¡åˆ†è¡¨
```sql
-- ä¸ºæ¯ä¸ªä¸»è¦æœåŠ¡åˆ›å»ºç‹¬ç«‹è¡¨
CREATE TABLE auth_service_logs AS application_logs;
CREATE TABLE api_service_logs AS application_logs;
CREATE TABLE payment_service_logs AS application_logs;
```

**ä¼˜åŠ¿**: æœåŠ¡éš”ç¦»ï¼Œç‹¬ç«‹æ‰©å±•
**åŠ£åŠ¿**: è·¨æœåŠ¡æŸ¥è¯¢å¤æ‚

### ç­–ç•¥2: æŒ‰æ—¥å¿—çº§åˆ«åˆ†è¡¨
```sql
-- é”™è¯¯æ—¥å¿—å•ç‹¬è¡¨ï¼ˆéœ€è¦é•¿æœŸä¿ç•™ï¼‰
CREATE TABLE error_logs (
  -- ... å­—æ®µå®šä¹‰ ...
  TTL timestamp + INTERVAL 365 DAY  -- ä¿ç•™1å¹´
);

-- æ™®é€šæ—¥å¿—è¡¨ï¼ˆçŸ­æœŸä¿ç•™ï¼‰
CREATE TABLE info_logs (
  -- ... å­—æ®µå®šä¹‰ ...
  TTL timestamp + INTERVAL 30 DAY   -- ä¿ç•™30å¤©
);
```

**ä¼˜åŠ¿**: ä¸åŒä¿ç•™ç­–ç•¥ï¼Œå­˜å‚¨ä¼˜åŒ–
**åŠ£åŠ¿**: åº”ç”¨é€»è¾‘å¤æ‚

### ç­–ç•¥3: åˆ†å¸ƒå¼è¡¨
```sql
-- åœ¨é›†ç¾¤çŽ¯å¢ƒä¸­ä½¿ç”¨åˆ†å¸ƒå¼è¡¨
CREATE TABLE application_logs_distributed AS application_logs 
ENGINE = Distributed(cluster, database, application_logs, rand())
```

**ä¼˜åŠ¿**: æ°´å¹³æ‰©å±•ï¼Œé«˜å¯ç”¨
**é€‚ç”¨**: é›†ç¾¤éƒ¨ç½²çŽ¯å¢ƒ

## ðŸ“‹ è¯„ä¼°æ¸…å•

åœ¨è€ƒè™‘åˆ†è¡¨å‰ï¼Œè¯·è¯„ä¼°ä»¥ä¸‹å› ç´ ï¼š

### âœ… æ€§èƒ½è¯„ä¼°
- [ ] å½“å‰æŸ¥è¯¢å“åº”æ—¶é—´æ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Ÿ
- [ ] å­˜å‚¨ç©ºé—´å¢žé•¿æ˜¯å¦å¯æŽ§ï¼Ÿ
- [ ] å†™å…¥æ€§èƒ½æ˜¯å¦æœ‰ç“¶é¢ˆï¼Ÿ

### âœ… ä¸šåŠ¡éœ€æ±‚
- [ ] æ˜¯å¦éœ€è¦ä¸åŒçš„æ•°æ®ä¿ç•™ç­–ç•¥ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æœåŠ¡é—´æ•°æ®éš”ç¦»ï¼Ÿ
- [ ] æ˜¯å¦æœ‰å¤šç§Ÿæˆ·éœ€æ±‚ï¼Ÿ

### âœ… è¿ç»´å¤æ‚åº¦
- [ ] å›¢é˜Ÿæ˜¯å¦æœ‰ç®¡ç†å¤šè¡¨çš„ç»éªŒï¼Ÿ
- [ ] ç›‘æŽ§å’Œå¤‡ä»½ç­–ç•¥æ˜¯å¦èƒ½é€‚åº”ï¼Ÿ
- [ ] åº”ç”¨ä»£ç æ”¹åŠ¨æˆæœ¬å¦‚ä½•ï¼Ÿ

## ðŸŽ¯ æŽ¨èæ–¹æ¡ˆ

### å¯¹äºŽå¤§å¤šæ•°åœºæ™¯ (æŽ¨è)
```
ä¿æŒå½“å‰çš„å•è¡¨è®¾è®¡ï¼Œç»§ç»­ä¼˜åŒ–ï¼š
1. ç›‘æŽ§æŸ¥è¯¢æ€§èƒ½
2. æ ¹æ®æŸ¥è¯¢æ¨¡å¼è°ƒæ•´æŽ’åºé”®
3. è€ƒè™‘æ·»åŠ è·³æ•°ç´¢å¼•
4. é€‚å½“è°ƒæ•´åˆ†åŒºç­–ç•¥
```

### å¯¹äºŽè¶…å¤§è§„æ¨¡åœºæ™¯
```
1. é¦–å…ˆå°è¯•æŸ¥è¯¢ä¼˜åŒ–
2. è€ƒè™‘ç¡¬ä»¶å‡çº§
3. æœ€åŽè€ƒè™‘åˆ†è¡¨ç­–ç•¥
```

## ðŸ”§ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æŸ¥è¯¢ä¼˜åŒ–
```sql
-- åˆ©ç”¨åˆ†åŒºè£å‰ª
SELECT * FROM application_logs 
WHERE timestamp >= '2025-12-01' AND timestamp < '2025-12-11'
  AND level = 'error'
  AND service = 'auth-service'

-- é¿å…å…¨è¡¨æ‰«æ
SELECT count() FROM application_logs 
WHERE toYYYYMM(timestamp) = 202512  -- åˆ©ç”¨åˆ†åŒº
```

### 2. ç´¢å¼•ä¼˜åŒ–
```sql
-- è€ƒè™‘æ·»åŠ è·³æ•°ç´¢å¼•
ALTER TABLE application_logs 
ADD INDEX idx_service service TYPE bloom_filter GRANULARITY 1;

ALTER TABLE application_logs 
ADD INDEX idx_level level TYPE set(0) GRANULARITY 1;
```

### 3. ç‰©åŒ–è§†å›¾
```sql
-- ä¸ºé¢‘ç¹çš„ç»Ÿè®¡æŸ¥è¯¢åˆ›å»ºç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW logs_hourly_stats
ENGINE = SummingMergeTree()
PARTITION BY toYYYYMM(hour)
ORDER BY (hour, service, level)
AS SELECT
  toStartOfHour(timestamp) as hour,
  service,
  level,
  count() as count
FROM application_logs
GROUP BY hour, service, level;
```

## ðŸ“Š ç›‘æŽ§æŒ‡æ ‡

å®šæœŸç›‘æŽ§ä»¥ä¸‹æŒ‡æ ‡æ¥è¯„ä¼°æ˜¯å¦éœ€è¦åˆ†è¡¨ï¼š

- **æŸ¥è¯¢å“åº”æ—¶é—´**: < 1ç§’ä¸ºä¼˜ç§€ï¼Œ< 5ç§’ä¸ºå¯æŽ¥å—
- **å­˜å‚¨å¢žé•¿**: æœˆå¢žé•¿é‡å’Œæ€»å­˜å‚¨é‡
- **å†™å…¥æ€§èƒ½**: æ¯ç§’æ’å…¥è¡Œæ•°
- **åˆ†åŒºæ•°é‡**: é¿å…è¿‡å¤šå°åˆ†åŒº
- **å†…å­˜ä½¿ç”¨**: æŸ¥è¯¢æ—¶çš„å†…å­˜æ¶ˆè€—

## ðŸš€ ç»“è®º

å¯¹äºŽå½“å‰çš„æ—¥å¿—æœåŠ¡ï¼š
1. **çŸ­æœŸ**: ä¿æŒå•è¡¨è®¾è®¡ï¼Œä¸“æ³¨äºŽæŸ¥è¯¢ä¼˜åŒ–
2. **ä¸­æœŸ**: æ ¹æ®å®žé™…æ•°æ®é‡å’ŒæŸ¥è¯¢æ¨¡å¼è°ƒæ•´
3. **é•¿æœŸ**: å¦‚æžœç¡®å®žéœ€è¦ï¼Œå†è€ƒè™‘åˆ†è¡¨ç­–ç•¥

ClickHouseçš„å•è¡¨è®¾è®¡å·²ç»èƒ½å¾ˆå¥½åœ°å¤„ç†å¤§éƒ¨åˆ†æ—¥å¿—åœºæ™¯ï¼Œè¿‡æ—©çš„åˆ†è¡¨å¯èƒ½ä¼šå¢žåŠ ä¸å¿…è¦çš„å¤æ‚åº¦ã€‚ 